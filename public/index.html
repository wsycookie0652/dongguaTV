<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- æ ¸å¿ƒï¼šä¸å‘é€ Referrer -->
    <meta name="referrer" content="no-referrer">
    <title>Eè§†ç•Œ</title>

    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">
    <meta name="theme-color" content="#141414">

    <!-- Cloudflare CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.1.5/hls.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dplayer/1.26.0/DPlayer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.47/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --bg-color: #141414;
            --panel-bg: #1f1f1f;
            --accent: #e50914;
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            min-height: 100vh;
            padding-bottom: 60px;
            overflow-x: hidden;
        }

        /* å±è”½ DPlayer æç¤º */
        .dplayer-notice,
        .dplayer-notice-list {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        /* å…¨å±€æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #141414;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* å¯¼èˆª */
        .navbar-custom {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            padding: 15px 4%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
            transition: 0.3s;
        }

        .navbar-custom.scrolled {
            background: #141414;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        .brand {
            font-size: 26px;
            font-weight: 800;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
        }

        /* Hero */
        .carousel-item {
            height: 70vh;
            background-color: #000;
        }

        .hero-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center top;
            transition: transform 10s ease;
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }

        .carousel-item.active .hero-bg {
            transform: scale(1.05);
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, #141414 0%, transparent 60%), linear-gradient(to right, rgba(0, 0, 0, 0.8) 0%, transparent 50%);
            display: flex;
            align-items: center;
            padding-left: 5%;
        }

        .hero-content {
            max-width: 600px;
            margin-top: 60px;
            animation: fadeInUp 0.8s;
        }

        .hero-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 15px;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
        }

        .hero-desc {
            font-size: 1.1rem;
            color: #ddd;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            margin-bottom: 25px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .btn-play {
            background: #fff;
            color: #000;
            border: none;
            padding: 10px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-play:hover {
            transform: scale(1.05);
        }

        .btn-info {
            background: rgba(109, 109, 110, 0.7);
            color: #fff;
            border: none;
            padding: 10px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
            backdrop-filter: blur(5px);
        }

        .btn-info:hover {
            background: rgba(109, 109, 110, 0.5);
        }

        @media(max-width: 768px) {
            .carousel-item {
                height: 55vh;
            }

            .hero-title {
                font-size: 2.2rem;
            }

            .btn-play,
            .btn-info {
                padding: 8px 20px;
                font-size: 1rem;
            }
        }

        /* æœç´¢æ¡† */
        .search-section {
            position: sticky;
            top: 10px;
            /* å¸é¡¶æ—¶ä½äº Navbar å†…éƒ¨ */
            margin-top: -35px;
            z-index: 1001;
            /* é«˜äº Navbar */
            padding: 0 4%;
            /* å¯¹é½ Navbar Padding */
            margin-bottom: 30px;
            pointer-events: none;
        }

        .search-box-wrapper {
            pointer-events: auto;
            background: rgba(20, 20, 20, 0.95);
            /* åŠ æ·±èƒŒæ™¯ï¼Œé˜²æ­¢é€è§†å¹²æ‰° */
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            /* æ›´åœ†æ¶¦ */
            display: flex;
            align-items: center;
            transition: 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            /* æ’‘æ»¡ */
            max-width: none;
            margin: 0 auto;
        }

        .search-box-wrapper.compact {
            max-width: 280px;
            height: 40px;
            margin-right: 0;
            /* å³å¯¹é½ */
            margin-left: auto;
            background: rgba(40, 40, 40, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-box-wrapper.compact .search-input {
            height: 40px;
            font-size: 14px;
        }

        .search-box-wrapper.compact .search-icon {
            font-size: 14px;
            padding: 0 12px;
        }

        .btn-top {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e50914, #b20710);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            z-index: 1000;
            border: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .btn-top.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .btn-top:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 15px 30px rgba(229, 9, 20, 0.5);
        }



        .search-box-wrapper:focus-within {
            border-color: var(--accent);
            background: #000;
        }

        .search-icon {
            padding: 0 20px;
            color: #888;
            font-size: 18px;
            cursor: pointer;
        }

        .search-input {
            width: 100%;
            height: 60px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 18px;
            outline: none;
        }

        /* åˆ†ç±»å¯¼èˆªæ  */
        .category-nav-container {
            display: flex;
            overflow-x: auto;
            padding: 20px 4%;
            gap: 20px;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .category-nav-container::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .category-item {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            width: 70px;
            transition: transform 0.2s;
        }

        .category-item:hover {
            transform: translateY(-5px);
        }

        .category-item span {
            font-size: 12px;
            color: #aaa;
            font-weight: 500;
        }

        .category-item:hover span {
            color: #fff;
        }

        .cat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* åˆ—è¡¨é€šç”¨ */
        .section-container {
            padding: 0 5%;
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-line {
            width: 4px;
            height: 22px;
            background: var(--accent);
            border-radius: 2px;
            margin-right: 12px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            margin: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 1.1rem;
            opacity: 0.7;
        }

        /* æ»šåŠ¨å®¹å™¨ */
        .scroll-container {
            position: relative;
        }

        .hot-row {
            display: flex;
            gap: 14px;
            overflow-x: auto;
            padding-bottom: 20px;
            scroll-behavior: smooth;
        }

        .hot-row::-webkit-scrollbar {
            height: 0px;
        }

        /* æ»šåŠ¨æŒ‰é’® */
        .scroll-btn {
            position: absolute;
            top: 35%;
            transform: translateY(-50%);
            width: 36px;
            height: 80px;
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(50, 50, 50, 0.9) 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            opacity: 0.6;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .scroll-btn:hover {
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.9) 0%, rgba(180, 0, 15, 0.85) 100%);
            opacity: 1;
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(229, 9, 20, 0.4);
        }

        .scroll-btn.left {
            left: -5px;
            border-radius: 0 8px 8px 0;
        }

        .scroll-btn.right {
            right: -5px;
            border-radius: 8px 0 0 8px;
        }

        @media (max-width: 768px) {
            .scroll-btn {
                display: none;
                /* ç§»åŠ¨ç«¯éšè—ï¼Œä½¿ç”¨æ‰‹æŒ‡æ»‘åŠ¨ */
            }
        }

        .hot-card {
            min-width: 150px;
            width: 150px;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }

        .hot-card:hover {
            transform: scale(1.08);
            z-index: 10;
        }

        .poster-wrap {
            width: 100%;
            aspect-ratio: 2/3;
            border-radius: 6px;
            overflow: hidden;
            background: #222;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
        }

        .poster-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s;
        }

        .rank-badge {
            position: absolute;
            top: -12px;
            left: -8px;
            font-size: 64px;
            font-weight: 900;
            color: #141414;
            -webkit-text-stroke: 2px #666;
            font-family: impact, sans-serif;
            text-shadow: 2px 2px 0px #eee;
            z-index: 10;
            pointer-events: none;
            line-height: 1;
        }

        .rating-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            color: #46d369;
            font-weight: bold;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(70, 211, 105, 0.3);
        }

        .poster-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #333 0%, #111 100%);
            padding: 5px;
            text-align: center;
        }

        .fallback-text {
            font-size: 12px;
            color: #999;
        }

        .movie-name {
            margin-top: 10px;
            font-size: 14px;
            color: #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            font-weight: 500;
        }

        .movie-date {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            min-height: 300px;
        }

        .result-card {
            cursor: pointer;
            transition: 0.2s;
        }

        .result-card:hover {
            transform: translateY(-5px);
        }

        /* â˜…â˜…â˜… æ’­æ”¾é¡µé‡æ„ï¼šå½±é™¢æ¨¡å¼ â˜…â˜…â˜… */
        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #141414;
            z-index: 9999;
            display: none;
            overflow-y: auto;
        }

        .detail-overlay.active {
            display: block;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .close-btn {
            position: fixed;
            top: 25px;
            right: 30px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            z-index: 10005;
            backdrop-filter: blur(10px);
            transition: 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        /* å¸ƒå±€å®¹å™¨ */
        .player-layout {
            max-width: 1200px;
            margin: 0 auto;
            padding: 90px 4% 50px;
        }

        /* è§†é¢‘åŒºåŸŸ */
        .player-box {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        /* è§†é¢‘ä¿¡æ¯æ  */
        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .video-title {
            font-size: 2.2rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .video-meta {
            color: #888;
            font-size: 14px;
        }

        /* æŠ•å±æŒ‰é’® */
        .btn-cast {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            color: #fff;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-cast:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* æ§åˆ¶åŒºåŸŸ (ä¸‹åŠéƒ¨åˆ†) */
        .controls-area {
            background: #1f1f1f;
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* çº¿è·¯é€‰æ‹© (æ¨ªå‘æ»šåŠ¨) */
        .panel-title {
            font-size: 14px;
            color: #888;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .source-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .source-pill {
            padding: 8px 16px;
            border-radius: 6px;
            background: #2a2a2a;
            border: 1px solid #333;
            color: #ccc;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .source-pill:hover {
            background: #333;
            border-color: #666;
            color: #fff;
        }

        .source-pill.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.3);
        }

        /* é€‰é›† (å¤§ç½‘æ ¼) */
        .ep-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            /* è‡ªé€‚åº”å®½åº¦ï¼Œæœ€å°100px */
            gap: 12px;
        }

        .ep-btn {
            background: #2a2a2a;
            border: 1px solid transparent;
            color: #ddd;
            padding: 12px 5px;
            text-align: center;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ep-btn:hover {
            background: #333;
            color: #fff;
            border-color: #555;
        }

        .ep-btn.active {
            background: #fff;
            color: #000;
            font-weight: bold;
            border-color: #fff;
        }

        /* çŠ¶æ€ç¯ */
        .latency-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .dot-green {
            background: #46d369;
            box-shadow: 0 0 5px #46d369;
        }

        .dot-yellow {
            background: #ffcc00;
        }

        .dot-red {
            background: #ff453a;
        }

        .footer {
            text-align: center;
            font-size: 12px;
            color: #444;
            margin-top: 80px;
            padding-bottom: 20px;
        }

        /* ç”µå½±è¯¦æƒ…å¼¹çª— */
        .info-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .info-modal {
            position: relative;
            max-width: 800px;
            width: 100%;
            background: #181818;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .info-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            font-size: 16px;
        }

        .info-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .info-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 250px;
            background-size: cover;
            background-position: center;
            opacity: 0.4;
        }

        .info-modal-backdrop::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent, #181818);
        }

        .info-modal-content {
            position: relative;
            display: flex;
            gap: 25px;
            padding: 30px;
            padding-top: 180px;
        }

        .info-modal-poster {
            flex-shrink: 0;
            width: 180px;
        }

        .info-modal-poster img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .info-modal-details {
            flex: 1;
        }

        .info-modal-details h2 {
            font-size: 1.8rem;
            margin-bottom: 12px;
            color: #fff;
        }

        .info-modal-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 15px;
        }

        .info-rating {
            color: #ffc107;
            font-weight: bold;
        }

        .info-overview {
            color: #bbb;
            font-size: 14px;
            line-height: 1.7;
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .info-modal-btns {
            display: flex;
            gap: 12px;
        }

        @media (max-width: 600px) {
            .info-modal-content {
                flex-direction: column;
                padding-top: 200px;
                text-align: center;
            }

            .info-modal-poster {
                width: 120px;
                margin: 0 auto;
            }

            .info-modal-meta {
                justify-content: center;
            }

            .info-modal-btns {
                justify-content: center;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Loading Screen */
        .app-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            /* Deep dark background */
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        .app-loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-logo {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(45deg, #e50914, #ff5151);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            letter-spacing: 2px;
            animation: pulse 2s infinite;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #e50914;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }
    </style>
</head>

<body>
    <!-- Initial Loading Screen (Buffer) -->
    <div id="app-loader" class="app-loader">
        <div class="loader-logo">Eè§†ç•Œ <span
                style="font-size:1.2rem; -webkit-text-fill-color: #fff; opacity:0.8;">MAX</span></div>
        <div class="loader-spinner"></div>
    </div>

    <div id="app">

        <nav class="navbar-custom" :class="{ 'scrolled': scrollY > 50 }" v-show="!searched">
            <div class="brand" @click="goHome" style="cursor: pointer;">Eè§†ç•Œ <span
                    style="font-size:12px; color:#666; font-weight:normal;">MAX</span></div>
        </nav>

        <!-- Back to Top Button -->
        <button class="btn-top" :class="{ show: scrollY > 500 }" @click="scrollToTop">
            <i class="fas fa-arrow-up"></i>
        </button>

        <!-- 1. Hero Carousel -->
        <div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="6000"
            v-if="!searched">
            <div class="carousel-inner" v-if="heroList.length > 0">
                <div class="carousel-item" v-for="(item, index) in heroList" :key="index"
                    :class="{ active: index === 0 }">
                    <div class="hero-bg" :style="{ backgroundImage: 'url(' + item.backdrop + ')' }"></div>
                    <div class="hero-overlay">
                        <div class="hero-content">
                            <div class="hero-tag">æœ¬å‘¨ TOP {{ index + 1 }}</div>
                            <h1 class="hero-title">{{ item.title }}</h1>
                            <p class="hero-desc">{{ item.overview }}</p>
                            <div class="hero-btns" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn-play" @click="autoSearch(item.title)"><i class="fas fa-play"></i>
                                    æ’­æ”¾</button>
                                <button class="btn-info" @click="showMovieInfo(item.rawData)"><i
                                        class="fas fa-info-circle"></i> æ›´å¤šä¿¡æ¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Search -->
        <div class="search-section"
            :style="{ marginTop: searched ? '60px' : '-35px', position: searched ? 'relative' : 'sticky' }">
            <div class="search-box-wrapper" :class="{ 'compact': !searched && scrollY > 400 }">
                <i class="fas fa-search search-icon" @click="doSearch"></i>
                <input type="text" v-model="keyword" @keyup.enter="doSearch" @input="debouncedSearch"
                    class="search-input" placeholder="è¾“å…¥ç‰‡åæˆ–å‰§é›†åç§°...">
            </div>
        </div>

        <div v-if="!searched">
            <!-- åˆ†ç±»å¯¼èˆªæ  -->
            <div class="category-nav-container animate__animated animate__fadeInUp" style="margin-bottom: 40px;">
                <div class="category-item" v-for="item in categories" :key="item.name" @click="handleCatClick(item)">
                    <div class="cat-icon" :style="{ background: item.color }">
                        <i :class="['fas', item.icon]"></i>
                    </div>
                    <span>{{ item.name }}</span>
                </div>
            </div>
            <!-- åŠ¨æ€ç”Ÿæˆçš„æ¦œå• Rows -->
            <div class="section-container animate__animated animate__fadeInUp" v-for="(config, key) in rowConfigs"
                :key="key" v-show="rowLists[key] && rowLists[key].length > 0">
                <div class="section-header">
                    <div class="section-line"></div>
                    <div class="section-title"><i :class="['fas', config.icon]"></i> {{ config.title }}</div>
                </div>
                <div class="scroll-container">
                    <button class="scroll-btn left" @click="scrollRow(key, -1)"><i
                            class="fas fa-chevron-left"></i></button>
                    <div class="hot-row" :ref="key">
                        <div class="hot-card" v-for="item in rowLists[key]" :key="item.id"
                            @click="autoSearch(item.title || item.name)">
                            <div class="poster-wrap">
                                <img :src="item.poster_path ? 'https://image.tmdb.org/t/p/w300' + item.poster_path : 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27450%27%3E%3Crect fill=%27%23333%27 width=%27300%27 height=%27450%27/%3E%3Ctext fill=%27%23666%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27 font-size=%2720%27%3ENo Image%3C/text%3E%3C/svg%3E'"
                                    loading="lazy">
                                <div class="rating-badge"><i class="fas fa-star text-warning"></i> {{ item.vote_average
                                    ? item.vote_average.toFixed(1) : 'N/A' }}</div>
                            </div>
                            <div class="movie-name">{{ item.title || item.name }}</div>
                            <div class="movie-date">{{ (item.release_date || item.first_air_date || '').split('-')[0] }}
                            </div>
                        </div>
                    </div>
                    <button class="scroll-btn right" @click="scrollRow(key, 1)"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-result-anchor" class="section-container" v-if="searched">
            <div class="d-flex align-items-center gap-2 mb-5 mt-2">
                <button class="btn btn-outline-secondary rounded-pill px-3 px-md-4 py-2" @click="goHome"
                    style="color: #fff; border-color: rgba(255,255,255,0.3);">
                    <i class="fas fa-arrow-left me-0 me-md-2"></i><span class="d-none d-md-inline">è¿”å›é¦–é¡µ</span>
                </button>
                <div class="section-header mb-0 ms-3 ms-md-4">
                    <div class="section-line"></div>
                    <div class="section-title">æ­£åœ¨æœç´¢: "{{ keyword }}"</div>
                </div>
            </div>

            <!-- æœç´¢ç»“æœç½‘æ ¼ (å³ä½¿åœ¨ loading ä¹Ÿå¯ä»¥æ˜¾ç¤º) -->
            <div class="result-grid" v-if="groupedList.length > 0">
                <div class="result-card" v-for="group in groupedList" :key="group.name" @click="openDetail(group)">
                    <div class="poster-wrap">
                        <img v-if="!isFallback(group.name)" :src="finalPoster(group)" :key="finalPoster(group)"
                            referrerpolicy="no-referrer" @error="handleImgError(group.name)" loading="lazy">
                        <div v-else class="poster-fallback">
                            <i class="fas fa-film mb-2 opacity-50"></i>
                            <div style="font-size:12px; color:#999">{{ group.name }}</div>
                        </div>
                        <div class="rating-badge" style="background:var(--accent); color:#fff; border:none;">
                            {{ group.sources.length }} æº
                        </div>
                    </div>
                    <div class="movie-name">{{ group.name }}</div>
                </div>
            </div>

            <!-- åŠ è½½ä¸­æç¤º (å¦‚æœæ²¡ç»“æœå±…ä¸­ï¼Œæœ‰ç»“æœåœ¨åº•éƒ¨) -->
            <div v-if="loading" class="text-center py-4">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2 text-muted small" v-if="groupedList.length > 0">æ­£åœ¨æœç´¢æ›´å¤šèµ„æº...</div>
                <div class="mt-2 text-muted small" v-else>æ­£åœ¨å…¨ç½‘æœç´¢...</div>
            </div>

            <div v-if="!loading && groupedList.length === 0" class="text-center"
                style="padding: 60px 20px; margin-top: -20px;">
                <i class="fas fa-search" style="font-size: 48px; color: #444; margin-bottom: 20px;"></i>
                <h4 style="color: #888; margin-bottom: 15px;">æš‚æœªæ‰¾åˆ°ã€Œ{{ keyword }}ã€çš„ç›¸å…³èµ„æº</h4>
                <div style="color: #666; font-size: 14px; line-height: 1.8; max-width: 400px; margin: 0 auto;">
                    <p style="margin-bottom: 8px;">ğŸ“Œ æ–°ä¸Šæ˜ çš„ç”µå½±/å‰§é›†å¯èƒ½éœ€è¦ç­‰å¾…1-2å‘¨æ‰æœ‰èµ„æº</p>
                    <p style="margin-bottom: 8px;">ğŸ’¡ å°è¯•æœç´¢ç”µå½±çš„ä¸­æ–‡å</p>
                    <p>ğŸ” æˆ–å°è¯•æœç´¢å…¶ä»–çƒ­é—¨å½±ç‰‡</p>
                </div>
                <button class="btn btn-outline-danger mt-4" @click="clearSearch"
                    style="border-radius: 20px; padding: 8px 25px;">
                    <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
                </button>
            </div>
        </div>

        <div class="footer">
            <div style="font-size:10px; margin-top:5px; opacity:0.5;">Data provided by TMDb & Maccms APIs</div>
        </div>

        <!-- â˜…â˜…â˜… TMDb ç”µå½±è¯¦æƒ…å¼¹çª— â˜…â˜…â˜… -->
        <div class="info-modal-overlay" v-if="showInfoModal" @click.self="showInfoModal = false">
            <div class="info-modal" v-if="infoModalData">
                <button class="info-modal-close" @click="showInfoModal = false"><i class="fas fa-times"></i></button>
                <div class="info-modal-backdrop"
                    :style="{ backgroundImage: 'url(' + TMDB_BACKDROP_URL + infoModalData.backdrop_path + ')' }"></div>
                <div class="info-modal-content">
                    <div class="info-modal-poster">
                        <img :src="TMDB_IMG_URL + infoModalData.poster_path"
                            :alt="infoModalData.title || infoModalData.name">
                    </div>
                    <div class="info-modal-details">
                        <h2>{{ infoModalData.title || infoModalData.name }}</h2>
                        <div class="info-modal-meta">
                            <span class="info-rating"><i class="fas fa-star text-warning"></i> {{
                                infoModalData.vote_average?.toFixed(1) }}</span>
                            <span>{{ (infoModalData.release_date || infoModalData.first_air_date)?.split('-')[0]
                                }}</span>
                            <span v-if="infoModalData.runtime">{{ infoModalData.runtime }} åˆ†é’Ÿ</span>
                        </div>
                        <p class="info-overview">{{ infoModalData.overview || 'æš‚æ— ç®€ä»‹' }}</p>
                        <div class="info-modal-btns">
                            <button class="btn-play"
                                @click="showInfoModal = false; autoSearch(infoModalData.title || infoModalData.name)">
                                <i class="fas fa-play"></i> ç«‹å³æ’­æ”¾
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â˜…â˜…â˜… æ’­æ”¾è¯¦æƒ…é¡µ (å½±é™¢å¸ƒå±€) â˜…â˜…â˜… -->
        <div class="detail-overlay" :class="{ active: showDetail }">
            <div class="close-btn" @click="closeDetail"><i class="fas fa-times"></i></div>

            <div class="player-layout" v-if="currentGroup">

                <!-- 1. é¡¶éƒ¨ï¼šæ ‡é¢˜æ  + æŠ•å± -->
                <div class="video-header">
                    <div>
                        <h1 class="video-title">{{ currentGroup.name }}</h1>
                        <div class="video-meta">
                            æ­£åœ¨æ’­æ”¾: <span class="text-white fw-bold">{{ currentSource?.site_name }}</span>
                        </div>
                    </div>
                    <button class="btn-cast" @click="castVideo">
                        <i class="fas fa-tv"></i> ä¸€é”®æŠ•å±
                    </button>
                </div>

                <!-- 2. ä¸­éƒ¨ï¼šè¶…å¤§æ’­æ”¾å™¨ -->
                <div class="player-box" style="position: relative;">
                    <div id="dplayer" style="width: 100%; height: 100%;"></div>
                    <!-- è‡ªåŠ¨åˆ‡æ¢çº¿è·¯æç¤º -->
                    <div v-if="autoRetryMessage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                               background: rgba(0,0,0,0.9); padding: 20px 30px; border-radius: 10px; 
                               text-align: center; z-index: 100; border: 1px solid rgba(255,255,255,0.1);">
                        <i class="fas fa-sync-alt fa-spin"
                            style="font-size: 24px; color: #e50914; margin-bottom: 10px;"></i>
                        <div style="color: #fff; font-weight: bold;">{{ autoRetryMessage }}</div>
                        <div style="color: #888; font-size: 12px; margin-top: 5px;">æ­£åœ¨è‡ªåŠ¨åˆ‡æ¢...</div>
                    </div>
                </div>

                <!-- 3. åº•éƒ¨ï¼šæ§åˆ¶é¢æ¿ -->
                <div class="controls-area">
                    <!-- å‰§é›†ç®€ä»‹ -->
                    <div class="mb-4" v-if="currentSource">
                        <div class="panel-title">å‰§æƒ…ç®€ä»‹</div>
                        <p
                            style="color: #999; font-size: 13px; line-height: 1.7; max-height: 80px; overflow-y: auto; margin: 0;">
                            <span v-if="loadingDetail"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</span>
                            <span v-else>{{ stripHtml(currentSource.vod_content) || 'æš‚æ— ç®€ä»‹ä¿¡æ¯' }}</span>
                        </p>
                    </div>

                    <!-- çº¿è·¯é€‰æ‹© -->
                    <div class="mb-4">
                        <div class="panel-title">
                            åˆ‡æ¢çº¿è·¯
                            <span v-if="isTestingSources" style="font-size: 12px; color: #888; font-weight: normal;">
                                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æµ‹é€Ÿ...
                            </span>
                        </div>

                        <!-- æµ‹é€Ÿç±»å‹å›¾ä¾‹ -->
                        <div v-if="!isTestingSources && (fastSources.length > 0 || slowSources.length > 0)"
                            style="font-size: 11px; color: #666; margin-bottom: 10px; display: flex; gap: 15px; align-items: center;">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <span
                                    style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px;">ç›´è¿</span>
                                ç”¨æˆ·ç«¯æµ‹é€Ÿï¼ˆæ›´å‡†ç¡®ï¼‰
                            </span>
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <span
                                    style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px;">ä»£ç†</span>
                                æœåŠ¡å™¨æµ‹é€Ÿ
                            </span>
                        </div>

                        <!-- å¿«é€Ÿçº¿è·¯åˆ—è¡¨ (< 600ms) -->
                        <div class="source-list" v-if="fastSources.length > 0 || slowSources.length > 0">
                            <!-- å¿«é€Ÿçº¿è·¯ -->
                            <div v-for="source in fastSources" class="source-pill"
                                :class="{ active: currentSource?.site_key === source.site_key }"
                                @click="switchSource(source)">
                                <span>{{ source.site_name }}</span>
                                <span class="latency-dot" :class="getLatencyClass(source.latency)"></span>
                                <span style="font-size:10px; opacity:0.6;">{{source.latency}}ms</span>
                                <span v-if="source._testType === 'direct'"
                                    style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                                    ç›´è¿
                                </span>
                                <span v-else
                                    style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                                    ä»£ç†
                                </span>
                            </div>
                            <!-- æ…¢é€Ÿçº¿è·¯åˆ†éš”ç¬¦ -->
                            <div v-if="slowSources.length > 0 && fastSources.length > 0"
                                style="width: 100%; font-size: 11px; color: #666; padding: 8px 0; border-top: 1px solid #333; margin-top: 5px;">
                                <i class="fas fa-hourglass-half"></i> è¾ƒæ…¢çº¿è·¯ ({{ slowSources.length }})
                            </div>
                            <!-- æ…¢é€Ÿçº¿è·¯ -->
                            <div v-for="source in slowSources" class="source-pill"
                                :class="{ active: currentSource?.site_key === source.site_key }" style="opacity: 0.7;"
                                @click="switchSource(source)">
                                <span>{{ source.site_name }}</span>
                                <span class="latency-dot" :class="getLatencyClass(source.latency)"></span>
                                <span style="font-size:10px; opacity:0.6;">{{source.latency}}ms</span>
                                <span v-if="source._testType === 'direct'"
                                    style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                                    ç›´è¿
                                </span>
                                <span v-else
                                    style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                                    ä»£ç†
                                </span>
                            </div>
                        </div>

                        <!-- å…¨éƒ¨ä¸å¯ç”¨æç¤º -->
                        <div v-else-if="!isTestingSources && fastSources.length === 0 && slowSources.length === 0"
                            class="text-center py-4"
                            style="background: rgba(255,0,0,0.1); border-radius: 8px; border: 1px solid rgba(255,0,0,0.2);">
                            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 24px;"></i>
                            <div class="mt-2" style="color: #ff6b6b;">æ‰€æœ‰é‡‡é›†ç«™å‡ä¸å¯ç”¨</div>
                            <div class="mt-1" style="font-size: 12px; color: #888;">è¯·ç¨åé‡è¯•æˆ–å°è¯•æœç´¢å…¶ä»–èµ„æº</div>
                        </div>
                    </div>

                    <!-- é€‰é›†åˆ—è¡¨ (å…¨å®½ç½‘æ ¼) -->
                    <div>
                        <div class="panel-title">é€‰é›†æ’­æ”¾</div>
                        <div v-if="loadingDetail" class="text-center py-5 text-muted"><i
                                class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>
                        <div v-else class="ep-grid">
                            <div v-for="ep in episodeList" class="ep-btn" :class="{ active: currentUrl === ep.url }"
                                @click="play(ep.url)">
                                {{ ep.name }}
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        const { createApp, reactive } = Vue;
        // TMDb API é…ç½® (ä»æœåŠ¡ç«¯è·å–)
        let TMDB_API_KEY = "";

        // TMDb URL é…ç½® (å¯æ ¹æ®ç”¨æˆ·åœ°åŒºåŠ¨æ€åˆ‡æ¢)
        // é»˜è®¤ä½¿ç”¨å®˜æ–¹åœ°å€
        let TMDB_BASE_URL = "https://api.themoviedb.org/3";
        let TMDB_IMG_URL = "https://image.tmdb.org/t/p/w500";
        let TMDB_BACKDROP_URL = "https://image.tmdb.org/t/p/original";

        // TMDB åä»£é…ç½®ç°åœ¨é€šè¿‡ç¯å¢ƒå˜é‡ TMDB_PROXY_URL é…ç½®
        // è¯¦è§ .env.example å’Œ cloudflare-tmdb-proxy.js

        let dp = null;

        createApp({
            data() {
                return {
                    searchTimer: null,  // é˜²æŠ–æœç´¢å®šæ—¶å™¨
                    isTestingSources: false,  // æ­£åœ¨æµ‹é€ŸçŠ¶æ€
                    showInfoModal: false,  // ç”µå½±è¯¦æƒ…å¼¹çª—
                    infoModalData: null,   // å¼¹çª—æ•°æ®
                    TMDB_IMG_URL: TMDB_IMG_URL,  // æ¨¡æ¿ä¸­ä½¿ç”¨
                    TMDB_BACKDROP_URL: TMDB_BACKDROP_URL,

                    // æ¢å¤ç¼ºå¤±çš„çŠ¶æ€å˜é‡
                    keyword: '', loading: false, searched: false, rawList: [],
                    showDetail: false, currentGroup: null, currentSource: null,
                    episodeList: [], currentUrl: '', loadingDetail: false,
                    imageMap: {}, fallbackMap: {}, heroList: [], scrollY: 0,
                    hotList: [],
                    sitesMap: {},  // ç¼“å­˜ç«™ç‚¹ä¿¡æ¯ï¼ˆç”¨äºå®¢æˆ·ç«¯æµ‹é€Ÿï¼‰
                    playbackErrorCount: 0,  // æ’­æ”¾å¤±è´¥è®¡æ•°
                    isAutoRetrying: false,  // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨é‡è¯•
                    autoRetryMessage: '',  // è‡ªåŠ¨åˆ‡æ¢æç¤ºä¿¡æ¯

                    // === åŠ¨æ€æ¦œå•é…ç½® ===
                    rowLists: {}, // å­˜å‚¨å„æ¦œå•æ•°æ® { movieRow: [...], ... }
                    rowConfigs: {
                        movieRow: { title: 'å…¨çƒéœ‡æ„ŸÂ·ç”µå½±æ¦œ', icon: 'fa-film', path: '/trending/movie/week', params: '', page: 1 },
                        tvRow: { title: 'å…¨çƒå¿…è¿½Â·å‰§é›†æ¦œ', icon: 'fa-tv', path: '/trending/tv/week', params: '', page: 1 },
                        cnRow: { title: 'åè¯­å¼ºæ¡£Â·å›½äº§å‰§', icon: 'fa-dragon', path: '/discover/tv', params: 'with_origin_country=CN&sort_by=popularity.desc', page: 1 },
                        usRow: { title: 'ç¾å‰§Â·é«˜èƒ½å‰§é›†', icon: 'fa-flag-usa', path: '/discover/tv', params: 'with_origin_country=US&sort_by=popularity.desc', page: 1 },
                        krjpRow: { title: 'æ—¥éŸ©æ½®æµÂ·å‰§é›†', icon: 'fa-mask', path: '/discover/tv', params: 'with_origin_country=KR|JP&sort_by=popularity.desc', page: 1 },
                        animeRow: { title: 'äºŒæ¬¡å…ƒÂ·åŠ¨æ¼«ç•ªå‰§', icon: 'fa-ghost', path: '/discover/tv', params: 'with_genres=16&sort_by=popularity.desc', page: 1 },
                        scifiRow: { title: 'ç§‘å¹»å¥‡å¹»Â·æ˜Ÿé™…ç©¿è¶Š', icon: 'fa-rocket', path: '/discover/movie', params: 'with_genres=878,14&sort_by=popularity.desc', page: 1 },
                        actionRow: { title: 'åŠ¨ä½œå¤§ç‰‡Â·è‚¾ä¸Šè…ºç´ ', icon: 'fa-bomb', path: '/discover/movie', params: 'with_genres=28&sort_by=popularity.desc', page: 1 },
                        comedyRow: { title: 'å¼€å¿ƒå–œå‰§Â·è§£å‹å¿…å¤‡', icon: 'fa-laugh-squint', path: '/discover/movie', params: 'with_genres=35&sort_by=popularity.desc', page: 1 },
                        crimeRow: { title: 'çŠ¯ç½ªæ‚¬ç–‘Â·çƒ§è„‘ç¥ä½œ', icon: 'fa-user-secret', path: '/discover/movie', params: 'with_genres=80,9648&sort_by=popularity.desc', page: 1 },
                        romanceRow: { title: 'çˆ±æƒ…Â·æµªæ¼«æ»¡å±‹', icon: 'fa-heart', path: '/discover/movie', params: 'with_genres=10749&sort_by=popularity.desc', page: 1 },
                        familyRow: { title: 'åˆå®¶æ¬¢Â·æ¸©é¦¨æ—¶åˆ»', icon: 'fa-home', path: '/discover/movie', params: 'with_genres=10751&sort_by=popularity.desc', page: 1 },
                        docRow: { title: 'çºªå½•ç‰‡Â·æ¢ç´¢ä¸–ç•Œ', icon: 'fa-video', path: '/discover/movie', params: 'with_genres=99&sort_by=popularity.desc', page: 1 },
                        warRow: { title: 'æˆ˜äº‰Â·å²è¯—å·¨åˆ¶', icon: 'fa-fighter-jet', path: '/discover/movie', params: 'with_genres=10752&sort_by=popularity.desc', page: 1 },
                        horrorRow: { title: 'ææ€–æƒŠæ‚šÂ·èƒ†å°å‹¿å…¥', icon: 'fa-skull', path: '/discover/movie', params: 'with_genres=27&sort_by=popularity.desc', page: 1 },
                        mysteryRow: { title: 'çƒ§è„‘æ‚¬ç–‘Â·å±‚å±‚åè½¬', icon: 'fa-search', path: '/discover/movie', params: 'with_genres=9648&sort_by=popularity.desc', page: 1 },
                        fantasyRow: { title: 'å¥‡å¹»å†’é™©Â·å¼‚æƒ³å¤©å¼€', icon: 'fa-hat-wizard', path: '/discover/movie', params: 'with_genres=14&sort_by=popularity.desc', page: 1 },
                        varietyRow: { title: 'çƒ­é—¨ç»¼è‰ºÂ·å¨±ä¹ç”Ÿæ´»', icon: 'fa-microphone-alt', path: '/discover/tv', params: 'with_genres=10764&sort_by=popularity.desc', page: 1 },
                        historyRow: { title: 'å†å²Â·å²æœˆé•¿æ²³', icon: 'fa-landmark', path: '/discover/movie', params: 'with_genres=36&sort_by=popularity.desc', page: 1 },
                        adventureRow: { title: 'æƒŠé™©å†’é™©Â·å‹‡æ•¢è€…æ¸¸æˆ', icon: 'fa-compass', path: '/discover/movie', params: 'with_genres=12&sort_by=popularity.desc', page: 1 },
                    },

                    movieList: [], tvList: [], list_cn: [], list_krjp: [],
                    list_scifi: [], list_action: [], list_comedy: [], list_horror: [],
                    categories: [
                        { name: 'ç”µå½±', icon: 'fa-film', action: 'scroll', value: 'movieRow', color: 'linear-gradient(135deg, #FF512F 0%, #DD2476 100%)' },
                        { name: 'å‰§é›†', icon: 'fa-tv', action: 'scroll', value: 'tvRow', color: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
                        { name: 'å›½äº§', icon: 'fa-dragon', action: 'scroll', value: 'cnRow', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
                        { name: 'ç¾å‰§', icon: 'fa-flag-usa', action: 'scroll', value: 'usRow', color: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' },
                        { name: 'æ—¥éŸ©', icon: 'fa-mask', action: 'scroll', value: 'krjpRow', color: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
                        { name: 'åŠ¨æ¼«', icon: 'fa-ghost', action: 'scroll', value: 'animeRow', color: 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)' },
                        { name: 'åŠ¨ä½œ', icon: 'fa-bomb', action: 'scroll', value: 'actionRow', color: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)' },
                        { name: 'ç§‘å¹»', icon: 'fa-rocket', action: 'scroll', value: 'scifiRow', color: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' },
                        { name: 'å–œå‰§', icon: 'fa-laugh-squint', action: 'scroll', value: 'comedyRow', color: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' },
                        { name: 'çŠ¯ç½ª', icon: 'fa-user-secret', action: 'scroll', value: 'crimeRow', color: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)' },
                        { name: 'çˆ±æƒ…', icon: 'fa-heart', action: 'scroll', value: 'romanceRow', color: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)' },
                        { name: 'æ‚¬ç–‘', icon: 'fa-search', action: 'scroll', value: 'mysteryRow', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                        { name: 'å†å²', icon: 'fa-landmark', action: 'scroll', value: 'historyRow', color: 'linear-gradient(135deg, #accbee 0%, #e7f0fd 100%)' },
                        { name: 'å®¶åº­', icon: 'fa-home', action: 'scroll', value: 'familyRow', color: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' },
                        { name: 'çºªå½•', icon: 'fa-video', action: 'scroll', value: 'docRow', color: 'linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%)' },
                        { name: 'æˆ˜äº‰', icon: 'fa-fighter-jet', action: 'scroll', value: 'warRow', color: 'linear-gradient(135deg, #ff0844 0%, #ffb199 100%)' },
                        { name: 'å†’é™©', icon: 'fa-compass', action: 'scroll', value: 'adventureRow', color: 'linear-gradient(135deg, #e9defa 0%, #fbfcdb 100%)' },
                        { name: 'ç»¼è‰º', icon: 'fa-microphone-alt', action: 'scroll', value: 'varietyRow', color: 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)' },
                        { name: 'ææ€–', icon: 'fa-skull', action: 'scroll', value: 'horrorRow', color: 'linear-gradient(135deg, #434343 0%, #000000 100%)' },
                        { name: 'å¥‡å¹»', icon: 'fa-hat-wizard', action: 'scroll', value: 'fantasyRow', color: 'linear-gradient(135deg, #fccb90 0%, #d57eeb 100%)' }
                    ]
                }
            },
            async mounted() {
                window.addEventListener('scroll', () => { this.scrollY = window.scrollY; });

                // 1. è·å–åç«¯é…ç½®
                try {
                    const res = await fetch('/api/config');
                    const config = await res.json();
                    TMDB_API_KEY = config.tmdb_api_key;

                    // å¦‚æœé…ç½®äº†åä»£åœ°å€ï¼Œè¿›è¡Œ IP æ£€æµ‹å¹¶åˆ‡æ¢
                    if (config.tmdb_proxy_url) {
                        await this.setupTmdbProxy(config.tmdb_proxy_url);
                    }
                } catch (e) {
                    console.error('Config Load Error:', e);
                }

                // 2. å¦‚æœè·å–åˆ°äº† Keyï¼ŒåŠ è½½æ•°æ®
                if (TMDB_API_KEY) {
                    this.fetchHero();
                    this.fetchAllLists();
                } else {
                    console.warn('TMDB_API_KEY æœªé…ç½®');
                    // å¯ä»¥åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºä¸€ä¸ªæç¤º
                }

                // 3. ç§»é™¤ Loading é®ç½© (å¹³æ»‘è¿‡æ¸¡)
                setTimeout(() => {
                    const loader = document.getElementById('app-loader');
                    if (loader) loader.classList.add('hidden');
                }, 800);

                // 4. åŠ è½½ç«™ç‚¹ä¿¡æ¯ï¼ˆç”¨äºå®¢æˆ·ç«¯æµ‹é€Ÿï¼‰
                try {
                    const sitesRes = await fetch('/api/sites');
                    const sitesData = await sitesRes.json();
                    if (sitesData.sites) {
                        sitesData.sites.forEach(site => {
                            this.sitesMap[site.key] = site;
                        });
                    }
                } catch (e) {
                    console.error('Sites Load Error:', e);
                }
            },
            computed: {
                groupedList() {
                    const groups = {};
                    this.rawList.forEach(item => {
                        const name = item.vod_name;
                        if (!groups[name]) groups[name] = { name: name, pic: item.vod_pic, sources: [] };
                        const isDefault = (url) => !url || url.includes('mac_default') || url.includes('nopic');
                        if (isDefault(groups[name].pic) && !isDefault(item.vod_pic)) groups[name].pic = item.vod_pic;
                        if (isDefault(groups[name].pic)) this.handleImgError(name);

                        groups[name].sources.push({
                            ...item,
                            latency: item.latency || 999
                        });
                    });
                    return Object.values(groups).sort((a, b) => b.sources.length - a.sources.length);
                },
                // å¿«é€Ÿçº¿è·¯ (å»¶è¿Ÿ < 600ms)
                fastSources() {
                    if (!this.currentGroup || !this.currentGroup.sources) return [];
                    return this.currentGroup.sources.filter(s => {
                        if (s.latency === '...') return false;
                        return typeof s.latency === 'number' && s.latency < 600;
                    });
                },
                // æ…¢é€Ÿçº¿è·¯ (600ms <= å»¶è¿Ÿ < 9000msï¼Œéè¶…æ—¶)
                slowSources() {
                    if (!this.currentGroup || !this.currentGroup.sources) return [];
                    return this.currentGroup.sources.filter(s => {
                        if (s.latency === '...') return false;
                        return typeof s.latency === 'number' && s.latency >= 600 && s.latency < 9000;
                    });
                },
                // å…¼å®¹æ—§ä»£ç çš„ availableSourcesï¼ˆåŒ…å«å¿«é€Ÿå’Œæ…¢é€Ÿï¼‰
                availableSources() {
                    return [...this.fastSources, ...this.slowSources];
                }
            },
            methods: {
                // æ»šåŠ¨åˆ°æŒ‡å®šåŒºåŸŸ
                scrollToSection(refName) {
                    let el = this.$refs[refName];
                    if (Array.isArray(el)) el = el[0]; // v-for ref ä¿®æ­£
                    if (el) {
                        const top = el.getBoundingClientRect().top + window.scrollY - 100;
                        window.scrollTo({ top: top, behavior: 'smooth' });
                    }
                },
                // å¤„ç†åˆ†ç±»ç‚¹å‡»
                handleCatClick(item) {
                    if (item.action === 'scroll') {
                        this.scrollToSection(item.value);
                    } else if (item.action === 'search') {
                        this.autoSearch(item.value);
                    }
                },

                // é˜²æŠ–æœç´¢ - è¾“å…¥æ—¶å®æ—¶æœç´¢
                debouncedSearch() {
                    clearTimeout(this.searchTimer);
                    if (!this.keyword || this.keyword.length < 2) {
                        // å…³é”®è¯å¤ªçŸ­æ—¶ä¸æœç´¢ï¼Œæ¸…é™¤ç»“æœ
                        if (!this.keyword) {
                            this.searched = false;
                            this.rawList = [];
                        }
                        return;
                    }
                    this.searchTimer = setTimeout(() => {
                        this.doSearch();
                    }, 500);  // 500ms é˜²æŠ–å»¶è¿Ÿ
                },

                // æ˜¾ç¤ºç”µå½±è¯¦æƒ…å¼¹çª—
                showMovieInfo(item) {
                    this.infoModalData = item;
                    this.showInfoModal = true;
                },

                // è®¾ç½® TMDB åä»£ï¼ˆé’ˆå¯¹å¤§é™†ç”¨æˆ·ï¼‰
                async setupTmdbProxy(proxyUrl) {
                    try {
                        const res = await fetch('https://ipapi.co/json/', { timeout: 3000 });
                        const data = await res.json();

                        if (data.country_code === 'CN') {
                            console.log('[IPæ£€æµ‹] æ£€æµ‹åˆ°å¤§é™†IPï¼Œå¯ç”¨TMDBåä»£:', proxyUrl);
                            TMDB_BASE_URL = proxyUrl + '/api/3';
                            TMDB_IMG_URL = proxyUrl + '/t/p/w500';
                            TMDB_BACKDROP_URL = proxyUrl + '/t/p/original';
                        } else {
                            console.log('[IPæ£€æµ‹] éå¤§é™†IPï¼Œä½¿ç”¨å®˜æ–¹åœ°å€');
                        }
                    } catch (e) {
                        console.warn('[IPæ£€æµ‹] æ£€æµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®', e);
                    }
                },

                // æ¸…ç† HTML æ ‡ç­¾
                stripHtml(html) {
                    if (!html) return '';
                    return html.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').trim();
                },

                getLatencyClass(ms) { return ms < 500 ? 'dot-green' : (ms < 2000 ? 'dot-yellow' : 'dot-red'); },
                castVideo() {
                    const videoEl = document.querySelector('.dplayer-video');
                    if (!videoEl) return alert('è¯·å…ˆæ’­æ”¾è§†é¢‘');
                    if (videoEl.remote && videoEl.remote.state !== 'disconnected') videoEl.remote.prompt().catch(() => { });
                    else if (videoEl.webkitShowPlaybackTargetPicker) videoEl.webkitShowPlaybackTargetPicker();
                    else alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç½‘é¡µç›´æ¥æŠ•å±ï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨èœå•ä¸­çš„æŠ•å°„åŠŸèƒ½ã€‚');
                },

                scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); },

                goHome() {
                    this.scrollToTop();
                    // å…³é—­æ’­æ”¾è¯¦æƒ…é¡µ
                    this.showDetail = false;
                    if (dp) dp.pause();
                    // æ¸…é™¤æœç´¢çŠ¶æ€
                    this.searched = false;
                    this.keyword = '';
                    this.rawList = [];
                    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                // åŠ è½½å•ä¸ªæ¦œå•æ•°æ®
                fetchRow(key, loadMore = false) {
                    const config = this.rowConfigs[key];
                    if (!config) return;
                    if (loadMore) config.page++; // å¢åŠ é¡µç 

                    const url = `${TMDB_BASE_URL}${config.path}?api_key=${TMDB_API_KEY}&language=zh-CN&page=${config.page}&${config.params}`;
                    fetch(url)
                        .then(res => res.json())
                        .then(data => {
                            if (data.results) {
                                // ç¡®ä¿å“åº”å¼æ›´æ–°
                                if (!this.rowLists[key]) {
                                    this.rowLists[key] = data.results;
                                } else if (loadMore) {
                                    this.rowLists[key].push(...data.results);
                                } else {
                                    this.rowLists[key] = data.results;
                                }
                            }
                        })
                        .catch(err => console.error(`Fetch error for ${key}:`, err));
                },

                // åˆå§‹åŒ–æ‰€æœ‰æ¦œå• (å¸¦å»¶è¿Ÿï¼Œé˜²æ­¢ API é€Ÿç‡é™åˆ¶)
                fetchAllLists() {
                    Object.keys(this.rowConfigs).forEach((key, index) => {
                        // æ¯ 250ms è¯·æ±‚ä¸€ä¸ªï¼Œé¿å…è§¦å‘ API é€Ÿç‡é™åˆ¶ (429 Too Many Requests)
                        setTimeout(() => {
                            this.fetchRow(key);
                        }, index * 250);
                    });
                },

                scrollRow(refName, direction) {
                    let row = this.$refs[refName];
                    // v-for ä¸­çš„ ref æ˜¯æ•°ç»„
                    if (Array.isArray(row)) row = row[0];

                    if (row) {
                        const scrollAmount = window.innerWidth * 0.5; // æ¯æ¬¡ç¿»åŠé¡µï¼Œä½“éªŒæ›´å¥½
                        row.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });

                        // å‘å³æ»šåŠ¨æ—¶è§¦å‘åŠ è½½ä¸‹ä¸€é¡µ
                        if (direction > 0) {
                            this.fetchRow(refName, true);
                        }
                    }
                },

                fetchHero() {
                    fetch(`${TMDB_BASE_URL}/trending/all/week?api_key=${TMDB_API_KEY}&language=zh-CN`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.results) {
                                this.heroList = data.results.filter(i => i.backdrop_path).slice(0, 5).map(item => ({
                                    title: item.title || item.name,
                                    overview: item.overview || 'ç²¾å½©å†…å®¹ä¸å®¹é”™è¿‡',
                                    backdrop: `${TMDB_BACKDROP_URL}${item.backdrop_path}`,
                                    rawData: item  // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºå¼¹çª—
                                }));
                            }
                        });
                },

                finalPoster(item, isHot = false) {
                    const name = isHot ? item.vod_name : item.name;
                    return this.imageMap[name] || (isHot ? item.vod_pic : item.pic);
                },
                isFallback(name) { return this.fallbackMap[name] === true; },

                handleImgError(name) {
                    if (this.imageMap[name] || this.fallbackMap[name]) return;
                    this.fallbackMap[name] = true;
                    let cleanName = name.replace(/ç¬¬[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[å­£éƒ¨]/g, '').replace(/Season\s*\d+/ig, '').replace(/S\d{1,2}/ig, '').replace(/(HD|BD|1080P|720P|4K|202\d|TC|TS).*/i, '').trim();
                    fetch(`${TMDB_BASE_URL}/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanName)}&language=zh-CN`)
                        .then(res => res.json()).then(data => {
                            if (data.results && data.results.length > 0) {
                                const found = data.results.find(i => i.poster_path) || data.results[0];
                                if (found.poster_path) {
                                    this.imageMap[name] = `${TMDB_IMG_URL}${found.poster_path}`;
                                    this.fallbackMap[name] = false;
                                }
                            }
                        }).catch(() => { });
                },



                autoSearch(name) {
                    this.keyword = name;
                    this.doSearch();
                },
                clearSearch() { this.searched = false; this.keyword = ''; this.rawList = []; },
                doSearch() {
                    if (!this.keyword) return;

                    if (this._evtSource) {
                        this._evtSource.close();
                        this._evtSource = null;
                    }

                    this.loading = true;
                    this.searched = true;
                    this.rawList = [];
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    const url = `/api/search?wd=${encodeURIComponent(this.keyword)}&stream=true`;
                    this._evtSource = new EventSource(url);

                    this._evtSource.onmessage = (e) => {
                        try {
                            const newItems = JSON.parse(e.data);
                            if (Array.isArray(newItems) && newItems.length > 0) {
                                this.rawList = this.rawList.concat(newItems);
                                newItems.forEach(item => {
                                    if (!item.vod_pic || item.vod_pic.includes('mac_default')) this.handleImgError(item.vod_name);
                                });
                            }
                        } catch (err) { }
                    };

                    this._evtSource.addEventListener('done', () => {
                        this.loading = false;
                        if (this._evtSource) {
                            this._evtSource.close();
                            this._evtSource = null;
                        }
                    });

                    this._evtSource.onerror = () => {
                        this.loading = false;
                        if (this._evtSource) {
                            this._evtSource.close();
                            this._evtSource = null;
                        }
                    };
                },
                async openDetail(group) {
                    this.currentGroup = group;
                    this.showDetail = true;
                    this.isTestingSources = true;  // å¼€å§‹æµ‹é€Ÿ
                    this.currentSource = null;  // ç¡®ä¿æ¸…ç©ºä¹‹å‰çš„é€‰æ‹©
                    this.episodeList = [];

                    // çœŸå®ç”¨æˆ·ç«¯æµ‹é€Ÿï¼šè·å–æ¯ä¸ªçº¿è·¯çš„è§†é¢‘URLï¼Œç›´æ¥ä»ç”¨æˆ·ç«¯æµ‹è¯•m3u8å»¶è¿Ÿ
                    // è¿™æ ·èƒ½çœŸæ­£åæ˜ ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®è¯¥è§†é¢‘æº

                    // å¿«é€Ÿè¿”å›æ ‡å¿—ï¼šä¸€æ—¦æœ‰2+å¿«é€Ÿçº¿è·¯ï¼Œç«‹å³è‡ªåŠ¨é€‰æ‹©æœ€å¿«çš„
                    let hasAutoSelected = false;
                    const FAST_THRESHOLD = 600;  // å¿«é€Ÿçº¿è·¯é˜ˆå€¼ (ms)
                    const EARLY_RETURN_COUNT = 2;  // æœ‰å‡ ä¸ªå¿«é€Ÿçº¿è·¯åæå‰è¿”å›
                    const MAX_WAIT_TIME = 3000;  // æœ€é•¿ç­‰å¾…æ—¶é—´ (ms)

                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æå‰è¿”å› - ä¼˜å…ˆç”¨æˆ·ç«¯æµ‹é€Ÿç»“æœ
                    const checkEarlyReturn = () => {
                        if (hasAutoSelected) return;

                        // ä¼˜å…ˆæ£€æŸ¥ç”¨æˆ·ç«¯æµ‹é€Ÿ(direct)çš„å¿«é€Ÿçº¿è·¯
                        const directFastSources = this.currentGroup.sources.filter(s =>
                            s._testType === 'direct' && typeof s.latency === 'number' && s.latency < FAST_THRESHOLD
                        );

                        if (directFastSources.length >= EARLY_RETURN_COUNT) {
                            hasAutoSelected = true;
                            directFastSources.sort((a, b) => a.latency - b.latency);
                            console.log(`[å¿«é€Ÿè¿”å›] å·²æ‰¾åˆ° ${directFastSources.length} ä¸ªç”¨æˆ·ç«¯å¿«é€Ÿçº¿è·¯ï¼Œè‡ªåŠ¨é€‰æ‹©: ${directFastSources[0].site_name} (${directFastSources[0].latency}ms ğŸ¬)`);
                            this.switchSource(directFastSources[0]);
                        }
                    };

                    // è¶…æ—¶è‡ªåŠ¨é€‰æ‹©ï¼ˆä¼˜å…ˆç”¨æˆ·ç«¯æµ‹é€Ÿï¼Œå…¶æ¬¡æœåŠ¡å™¨ç«¯ï¼‰
                    const earlyReturnTimer = setTimeout(() => {
                        if (hasAutoSelected) return;
                        hasAutoSelected = true;

                        // ä¼˜å…ˆé€‰æ‹©ç”¨æˆ·ç«¯æµ‹é€Ÿçš„ç»“æœ
                        let directSources = this.currentGroup.sources.filter(s =>
                            s._testType === 'direct' && typeof s.latency === 'number' && s.latency < 9000
                        );

                        if (directSources.length > 0) {
                            directSources.sort((a, b) => a.latency - b.latency);
                            console.log(`[è¶…æ—¶è¿”å›] é€‰æ‹©ç”¨æˆ·ç«¯æµ‹é€Ÿæœ€å¿«çš„: ${directSources[0].site_name} (${directSources[0].latency}ms ğŸ¬)`);
                            this.switchSource(directSources[0]);
                            return;
                        }

                        // æ²¡æœ‰ç”¨æˆ·ç«¯æµ‹é€Ÿç»“æœï¼Œå›é€€åˆ°æœåŠ¡å™¨ç«¯
                        const testedSources = this.currentGroup.sources.filter(s =>
                            typeof s.latency === 'number' && s.latency < 9000
                        );

                        if (testedSources.length > 0) {
                            testedSources.sort((a, b) => a.latency - b.latency);
                            console.log(`[è¶…æ—¶è¿”å›] ${MAX_WAIT_TIME}msåè‡ªåŠ¨é€‰æ‹©: ${testedSources[0].site_name} (${testedSources[0].latency}ms)`);
                            this.switchSource(testedSources[0]);
                        }
                    }, MAX_WAIT_TIME);

                    const latencyPromises = this.currentGroup.sources.map(async (source) => {
                        source.latency = '...';
                        try {
                            // 1. å…ˆè·å–è¯¥çº¿è·¯çš„è§†é¢‘è¯¦æƒ…
                            const detailRes = await fetch(`/api/detail?site_key=${source.site_key}&id=${source.vod_id}`);
                            const detailData = await detailRes.json();

                            if (!detailData.list || detailData.list.length === 0) {
                                source.latency = 9999;
                                return source;
                            }

                            // 2. è§£æå‡ºç¬¬ä¸€ä¸ª m3u8 è§†é¢‘ URL
                            const detail = detailData.list[0];
                            let playUrl = detail.vod_play_url || '';

                            // å¤„ç†å¤šçº¿è·¯æ ¼å¼ (ç”¨ $$$ åˆ†éš”)
                            if (playUrl.includes('$$$')) {
                                const sets = playUrl.split('$$$');
                                playUrl = sets.find(s => s.toLowerCase().includes('m3u8')) || sets[0];
                            }

                            // è·å–ç¬¬ä¸€ä¸ªè§†é¢‘URL
                            const firstEp = playUrl.split('#')[0];
                            const parts = firstEp.split('$');
                            const videoUrl = parts.length > 1 ? parts[1] : parts[0];

                            if (!videoUrl || !videoUrl.startsWith('http')) {
                                source.latency = 9999;
                                return source;
                            }

                            // æ£€æŸ¥æ··åˆå†…å®¹ï¼šå¦‚æœé¡µé¢æ˜¯ HTTPS ä½†è§†é¢‘ URL æ˜¯ HTTPï¼Œå›é€€åˆ°æœåŠ¡å™¨ç«¯æµ‹é€Ÿ
                            const isPageHttps = window.location.protocol === 'https:';
                            const isVideoHttp = videoUrl.startsWith('http:');

                            if (isPageHttps && isVideoHttp) {
                                // æ··åˆå†…å®¹ï¼Œæ— æ³•ç›´æ¥æµ‹è¯•ï¼Œå›é€€åˆ°æœåŠ¡å™¨ç«¯å»¶è¿Ÿ
                                console.log(`[æ··åˆå†…å®¹] ${source.site_name} è§†é¢‘URLä¸ºHTTPï¼Œå›é€€åˆ°æœåŠ¡å™¨æµ‹é€Ÿ`);
                                const checkRes = await fetch(`/api/check?key=${source.site_key}`);
                                const checkData = await checkRes.json();
                                source.latency = checkData.latency;
                                source._testType = 'server';  // æœåŠ¡å™¨ç«¯æµ‹é€Ÿ
                                source._cachedDetail = detail;
                                checkEarlyReturn();
                                return source;
                            }

                            // 3. ç”¨æˆ·ç«¯ç›´æ¥æµ‹è¯• m3u8 URL çš„å»¶è¿Ÿ
                            const startTime = Date.now();
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 5000);

                            // m3u8 æ–‡ä»¶é€šå¸¸é…ç½®äº† CORSï¼Œå¯ä»¥ç›´æ¥ fetch
                            const testRes = await fetch(videoUrl, {
                                method: 'GET',
                                cache: 'no-cache',
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);

                            if (testRes.ok || testRes.type === 'cors') {
                                source.latency = Date.now() - startTime;
                            } else {
                                source.latency = Date.now() - startTime;
                            }

                            // ç¼“å­˜è¯¦æƒ…æ•°æ®ï¼Œåç»­åˆ‡æ¢æ—¶å¯ä»¥å¤ç”¨
                            source._cachedDetail = detail;
                            source._testType = 'direct';  // ç”¨æˆ·ç«¯ç›´æ¥æµ‹é€Ÿ

                            // æ¯å®Œæˆä¸€ä¸ªæµ‹é€Ÿå°±æ£€æŸ¥æ˜¯å¦å¯ä»¥æå‰è¿”å›
                            checkEarlyReturn();

                        } catch (e) {
                            // å¦‚æœæ˜¯ CORS é”™è¯¯ï¼Œå°è¯• no-cors æ¨¡å¼å†æµ‹ä¸€æ¬¡
                            if (e.name !== 'AbortError') {
                                try {
                                    const detailRes = await fetch(`/api/detail?site_key=${source.site_key}&id=${source.vod_id}`);
                                    const detailData = await detailRes.json();
                                    if (detailData.list && detailData.list.length > 0) {
                                        source._cachedDetail = detailData.list[0];
                                        // æ— æ³•ç›´æ¥æµ‹è¯•ï¼Œå›é€€åˆ°æœåŠ¡å™¨ç«¯å»¶è¿Ÿ
                                        const checkRes = await fetch(`/api/check?key=${source.site_key}`);
                                        const checkData = await checkRes.json();
                                        source.latency = checkData.latency;
                                        source._testType = 'server';  // æœåŠ¡å™¨ç«¯æµ‹é€Ÿ
                                        checkEarlyReturn();
                                    } else {
                                        source.latency = 9999;
                                    }
                                } catch (e2) {
                                    source.latency = 9999;
                                }
                            } else {
                                source.latency = 9999;  // è¶…æ—¶
                            }
                        }
                        return source;
                    });

                    // ç­‰å¾…æ‰€æœ‰æµ‹é€Ÿå®Œæˆï¼ˆåå°ç»§ç»­ï¼‰
                    await Promise.all(latencyPromises);
                    clearTimeout(earlyReturnTimer);
                    this.isTestingSources = false;  // æµ‹é€Ÿå®Œæˆ

                    // æŒ‰å»¶è¿Ÿæ’åº (ä½åˆ°é«˜)
                    this.currentGroup.sources.sort((a, b) => {
                        const latA = typeof a.latency === 'number' ? a.latency : 9999;
                        const latB = typeof b.latency === 'number' ? b.latency : 9999;
                        return latA - latB;
                    });

                    // å¦‚æœå·²ç»æœ‰é€‰ä¸­çš„æºå¹¶ä¸”è§†é¢‘å·²å¼€å§‹æ’­æ”¾ï¼Œä¸å†è‡ªåŠ¨åˆ‡æ¢
                    // è¿™æ ·ä¸ä¼šæ‰“æ–­ç”¨æˆ·æ­£åœ¨è§‚çœ‹çš„å†…å®¹
                    if (hasAutoSelected && this.currentSource && this.currentUrl) {
                        console.log(`[æµ‹é€Ÿå®Œæˆ] ä¿æŒå½“å‰çº¿è·¯: ${this.currentSource.site_name}ï¼Œä¸è‡ªåŠ¨åˆ‡æ¢`);
                        return;
                    }

                    // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•æºï¼Œé€‰æ‹©æœ€å¿«çš„
                    if (!hasAutoSelected) {
                        // ä¼˜å…ˆé€‰æ‹©ç”¨æˆ·ç«¯æµ‹é€Ÿ(direct)çš„ç»“æœ
                        const directSources = this.currentGroup.sources.filter(s =>
                            s._testType === 'direct' && typeof s.latency === 'number' && s.latency < 9000
                        );

                        if (directSources.length > 0) {
                            console.log(`[æµ‹é€Ÿå®Œæˆ] é€‰æ‹©ç”¨æˆ·ç«¯æµ‹é€Ÿæœ€å¿«çš„çº¿è·¯: ${directSources[0].site_name} (${directSources[0].latency}ms)`);
                            this.switchSource(directSources[0]);
                        } else {
                            // å›é€€åˆ°æœåŠ¡å™¨ç«¯æµ‹é€Ÿæœ€å¿«çš„
                            const fastestAvailable = this.currentGroup.sources.find(s =>
                                typeof s.latency === 'number' && s.latency < 9000
                            );
                            if (fastestAvailable) {
                                console.log(`[æµ‹é€Ÿå®Œæˆ] é€‰æ‹©æœåŠ¡å™¨æµ‹é€Ÿæœ€å¿«çš„çº¿è·¯: ${fastestAvailable.site_name} (${fastestAvailable.latency}ms)`);
                                this.switchSource(fastestAvailable);
                            }
                        }
                    }
                    // å¦‚æœå…¨éƒ¨ä¸å¯ç”¨ï¼Œä¸è‡ªåŠ¨é€‰æ‹©ï¼ŒUIä¼šæ˜¾ç¤ºæç¤º
                },
                closeDetail() { this.showDetail = false; if (dp) dp.pause(); },
                async switchSource(source) {
                    this.currentSource = source;
                    this.loadingDetail = true;
                    this.episodeList = [];

                    try {
                        // ä¼˜å…ˆä½¿ç”¨æµ‹é€Ÿæ—¶ç¼“å­˜çš„è¯¦æƒ…æ•°æ®
                        let detail = source._cachedDetail;

                        if (!detail) {
                            // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œé‡æ–°è·å–
                            const res = await fetch(`/api/detail?site_key=${source.site_key}&id=${source.vod_id}`);
                            const data = await res.json();
                            if (data.list && data.list.length > 0) {
                                detail = data.list[0];
                            }
                        }

                        if (detail) {
                            // ä¿å­˜ç®€ä»‹ä¿¡æ¯åˆ°å½“å‰æº
                            this.currentSource.vod_content = detail.vod_content || detail.vod_blurb || '';
                            this.parseEpisodes(detail.vod_play_url);
                        }
                    } catch (e) { }
                    this.loadingDetail = false;
                },
                parseEpisodes(urlStr) {
                    let playSource = urlStr;
                    if (urlStr.includes('$$$')) {
                        const sets = urlStr.split('$$$');
                        playSource = sets.find(s => s.toLowerCase().includes('m3u8')) || sets[0];
                    }
                    this.episodeList = playSource.split('#').map(ep => {
                        const p = ep.split('$');
                        return { name: p.length > 1 ? p[0] : 'æ­£ç‰‡', url: p.length > 1 ? p[1] : p[0] };
                    });
                    if (this.episodeList.length > 0) this.play(this.episodeList[0].url);
                },
                play(url) {
                    this.currentUrl = url;
                    this.playbackErrorCount = 0;  // é‡ç½®é”™è¯¯è®¡æ•°

                    const setupErrorHandling = () => {
                        // ç›‘å¬æ’­æ”¾é”™è¯¯ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çº¿è·¯
                        dp.on('error', () => {
                            this.handlePlaybackError();
                        });

                        // ç›‘å¬ HLS é”™è¯¯
                        if (dp.video) {
                            dp.video.addEventListener('error', () => {
                                this.handlePlaybackError();
                            });
                        }
                    };

                    if (!dp) {
                        dp = new DPlayer({
                            container: document.getElementById('dplayer'),
                            theme: '#e50914',
                            video: { url: url, type: 'hls' }
                        });

                        // æ·»åŠ å…¨å±æ¨ªå±åŠŸèƒ½ï¼ˆæ‰‹æœºç«¯ï¼‰
                        dp.on('fullscreen', () => {
                            if (screen.orientation && screen.orientation.lock) {
                                screen.orientation.lock('landscape').catch(() => { });
                            }
                        });

                        dp.on('fullscreen_cancel', () => {
                            if (screen.orientation && screen.orientation.unlock) {
                                screen.orientation.unlock();
                            }
                        });

                        setupErrorHandling();
                    } else {
                        dp.switchVideo({ url: url, type: 'hls' });
                    }
                    dp.play();
                },

                // å¤„ç†æ’­æ”¾é”™è¯¯ï¼Œè‡ªåŠ¨åˆ‡æ¢çº¿è·¯
                handlePlaybackError() {
                    this.playbackErrorCount++;

                    // é¿å…é‡å¤è§¦å‘
                    if (this.isAutoRetrying || this.playbackErrorCount > 1) return;

                    // è·å–å½“å‰çº¿è·¯ç´¢å¼•
                    const allSources = this.availableSources;
                    const currentIndex = allSources.findIndex(s => s.site_key === this.currentSource?.site_key);

                    // å¦‚æœè¿˜æœ‰ä¸‹ä¸€ä¸ªçº¿è·¯å¯ç”¨ï¼Œè‡ªåŠ¨åˆ‡æ¢
                    if (currentIndex >= 0 && currentIndex < allSources.length - 1) {
                        this.isAutoRetrying = true;
                        const nextSource = allSources[currentIndex + 1];

                        // æ˜¾ç¤ºç”¨æˆ·æç¤º
                        this.autoRetryMessage = `${this.currentSource?.site_name} æ’­æ”¾å¤±è´¥ï¼Œæ­£åœ¨å°è¯• ${nextSource.site_name}`;
                        console.log(`[Auto-Failover] ${this.autoRetryMessage}`);

                        // æ ‡è®°å½“å‰çº¿è·¯ä¸ºä¸å¯ç”¨ï¼ˆè®¾ç½®é«˜å»¶è¿Ÿï¼‰
                        if (this.currentSource) {
                            this.currentSource.latency = 9998;  // æ ‡è®°ä¸ºç”¨æˆ·ç«¯ä¸å¯ç”¨
                        }

                        // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçº¿è·¯
                        setTimeout(() => {
                            this.autoRetryMessage = '';  // æ¸…é™¤æç¤º
                            this.isAutoRetrying = false;
                            this.switchSource(nextSource);
                        }, 1500);  // æ˜¾ç¤ºæç¤º1.5ç§’ååˆ‡æ¢
                    } else {
                        // æ²¡æœ‰æ›´å¤šå¯ç”¨çº¿è·¯
                        this.autoRetryMessage = 'æ‰€æœ‰çº¿è·¯å‡æ— æ³•æ’­æ”¾';
                        setTimeout(() => {
                            this.autoRetryMessage = '';
                        }, 3000);
                    }
                }
            }
        }).mount('#app');
    </script>

    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered: ', reg.scope))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</body>

</html>